@using System.Reflection;
@using PointerStar.Client.Services
@inherits LayoutComponentBase
@inject IThemeService ThemeService
@implements IDisposable

<Toolbelt.Blazor.PWA.Updater.PWAUpdater />
<MudThemeProvider @ref="@_mudThemeProvider" @bind-IsDarkMode="@_isDarkMode" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudText Typo="Typo.h5" Class="ml-3">Pointer*</MudText>
        <MudSpacer />
        <MudTooltip Text="@GetThemeTooltip()">
            <MudIconButton Icon="@GetThemeIcon()" Color="Color.Inherit" OnClick="@CycleThemeAsync" />
        </MudTooltip>
        <MudText Typo="Typo.subtitle1" Align="Align.End">@Assembly.GetExecutingAssembly().GetName().Version?.ToString(3)</MudText>
    </MudAppBar>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code {
    private bool _isDarkMode;
    private MudThemeProvider? _mudThemeProvider;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _mudThemeProvider is { } themeProvider)
        {
            await ThemeService.InitializeAsync(() => themeProvider.GetSystemDarkModeAsync());
            _isDarkMode = ThemeService.IsDarkMode;
            await themeProvider.WatchSystemDarkModeAsync(OnSystemPreferenceChanged);
            ThemeService.ThemeChanged += OnThemeChanged;
            StateHasChanged();
        }
    }

    private async Task OnSystemPreferenceChanged(bool newValue)
    {
        if (ThemeService is ThemeService themeService)
        {
            await themeService.UpdateSystemPreferenceAsync(newValue);
        }
    }

    private void OnThemeChanged(object? sender, EventArgs e)
    {
        _isDarkMode = ThemeService.IsDarkMode;
        StateHasChanged();
    }

    private async Task CycleThemeAsync()
    {
        await ThemeService.CycleThemeAsync();
    }

    private string GetThemeIcon()
    {
        return ThemeService.CurrentPreference switch
        {
            ThemePreference.Light => Icons.Material.Filled.LightMode,
            ThemePreference.Dark => Icons.Material.Filled.DarkMode,
            _ => Icons.Material.Filled.Brightness4
        };
    }

    private string GetThemeTooltip()
    {
        return ThemeService.CurrentPreference switch
        {
            ThemePreference.Light => "Theme: Light (click to switch to Dark)",
            ThemePreference.Dark => "Theme: Dark (click to switch to Light)",
            _ => "Toggle theme"
        };
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}
